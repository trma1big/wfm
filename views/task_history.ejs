<%- include('partials/header') %>    
<form id="filter_form" class="was-validated" validate>         
    <!-- <input type="text" name="wsname" id="wsname" value="<% if (typeof wsname != 'undefined') { %><%= wsname %><% } %>" hidden> -->
    <!-- <input type="text" name="taskname" id="taskname" value="<% if (typeof taskname != 'undefined') { %><%= taskname%><% } %>" hidden> -->
    
     <div class="row">
        <div class="col">
            <label for="wsname">Workflow</label>
            <select class="form-control" name="wsname" id="wsname" >
                
                <% if (typeof wsname != 'undefined') { %>
                    <option value="<%= wsname %>"><%= wsname %></option>
                <% } else { %>
                    <option value="none">-----------------</option>
                <% } %>
            </select>            
        </div>
        <div class="col">
            <label for="taskname">Task</label>
            <select disabled class="form-control" name="taskname" id="taskname">
                <% if (typeof taskname != 'undefined') { %>
                    <option value="<%= taskname%>"><%= taskname%></option>
                <% } %>
            </select>                        
        </div>
        <div class="col">
            <label for="startDate">From</label>
            <input id="startDate" class="form-control" type="date" value="<%= moment().subtract(1,'months').format('YYYY-MM-DD') %>"/>
        </div>
        <div class="col">
            <label for="startDate">To</label>
            <input id="endDate" class="form-control" type="date" value="<%= moment().format('YYYY-MM-DD') %>"/>
        </div>
        <div class="col">
            <label for="taskname">Graph Type</label>
            <select class="form-control" name="graph_type" id="graph_type">
                    <option value="table" selected>table</option>
                    <option value="line">line</option>
                    <option value="bar">bar</option>
                    <option value="radar">radar</option>
                    <option value="polarArea">polarArea</option>
            </select>                        
        </div>
        <!-- <div class="col-md-4 form-group">
            <div class="col-md-4 form-group">
                <div class="form-check">                    
                    <input class="form-check-input" type="radio" name="graph_type" id="graph_type" value="table" checked>                            
                    <label class="form-check-label" for="invalidCheck"><label for="graph_type"><span class="badge bg-secondary">table</span></label>  
                  </div>
                <div class="form-check">                    
                  <input class="form-check-input" type="radio" name="graph_type" id="graph_type" value="line">                            
                  <label class="form-check-label" for="invalidCheck"><label for="graph_type"><span class="badge bg-secondary">line</span></label>  
                </div>
                <div class="form-check">                    
                    <input class="form-check-input" type="radio" name="graph_type" id="graph_type" value="bar">                            
                    <label class="form-check-label" for="invalidCheck"><label for="graph_type"><span class="badge bg-secondary">bar</span></label>  
                </div>                
                <div class="form-check">                          
                  <input class="form-check-input" type="radio" name="graph_type" id="graph_type" value="radar">                            
                  <label class="form-check-label" for="invalidCheck"><label for="graph_type"><span class="badge bg-secondary">radar</span></label>  
                </div>
                <div class="form-check">                          
                    <input class="form-check-input" type="radio" name="graph_type" id="graph_type" value="polarArea">                            
                    <label class="form-check-label" for="invalidCheck"><label for="graph_type"><span class="badge bg-secondary">polarArea</span></label>  
                </div>                
            </div>
        </div> -->
        <!-- <div class="col"><div class="row">Line<input type="radio" id="line" name="graph_type" value="line" checked></div><div class="row">Radar<input type="radio" id="radar" name="graph_type" value="radar"></div></div> -->
        <div class="col"><button type="submit" class="btn btn-lg btn-lg btn-outline-success">FILTER</button></div>
     </div>               
</form>
<div id='divTable'>
<div class="table-responsive-xl" >
    <table id="dthist" class="table table-striped table-bordered" style="width:100%">
       <thead class="table-dark">
            <tr>     
            <th scope="col">workflow</th>  
            <th scope="col">task</th>                                 
            <th scope="col">Start date</th>
            <th scope="col">end date</th>                                                 
            <th scope="col">Duration ( Min )</th>
            </tr>
        </thead>               
    </table>
  </div>
</div>
  <div id="divchart">
    <canvas id="myChart" width="1200" height="600" style="display: block; box-sizing: border-box; height: 600px; width: 1200px;"></canvas>
    <!-- <canvas id="myChart"></canvas> -->
  </div>
<%- include('partials/footer') %>
<%- include('partials/rows_manager') %>
<script src="/datatables.net/js/jquery.dataTables.min.js" crossorigin="anonymous"></script> 
<script src="/datatables.net-bs5/js/dataTables.bootstrap5.min.js" crossorigin="anonymous"></script> 
<link rel="stylesheet" href="/datatables.net-bs5/css/dataTables.bootstrap5.min.css" crossorigin="anonymous">
<script src="/chart.js/dist/chart.js"></script>
<script>
    <% if (typeof wsname != 'undefined') { %>
        var wsname = <%- JSON.stringify(wsname) %>;
    <% } %>
</script>

<script>
    <% if (typeof taskname != 'undefined') { %>
        var taskname = <%- JSON.stringify(taskname) %>;
        <% } %>  
</script>


<script>    
//    document.getElementById("wsname").addEventListener("change", Enable_taskname_list($("#wsname").val(),taskname));
   document.getElementById("wsname").onchange = function(){Enable_taskname_list($("#wsname").val(),taskname)};
// onchange="Enable_taskname_list(wsname,taskname)";
    $("#filter_form").submit(function(e) {
        wsname = $("#wsname").val();
        if (wsname !== "none") {
            taskname = $("#taskname").val();
            // var myRadio = $("input[name=graph_type]");
            // var checkedValue = myRadio.filter(":checked").val(); 
            var checkedValue = $("#graph_type").val();       
            if (checkedValue === "table") {
                $('#divTable').show();
                $('#divchart').hide();
                
                dt_master.ajax.url( "/tasks/gethist/" + wsname + "/" + taskname + "/" + encodeURIComponent(formatDate(new Date($("#startDate").val()))) + "/" + encodeURIComponent(formatDate(new Date($("#endDate").val()))) );
                dt_master.ajax.reload();
            } else {            
                $('#divTable').hide();
                $('#divchart').show();  
                $.get("/tasks/gethist/" + wsname + "/" + taskname + "/" + encodeURIComponent(formatDate(new Date($("#startDate").val()))) + "/" + encodeURIComponent(formatDate(new Date($("#endDate").val()))), function(data, status){
                    var js = JSON.parse(data);
                    const labels = [];
                    const values = [];
                    js.forEach(function(item, index, object) {              
                        labels.push(item.start_date)
                        values.push(item.duration)   
                    });            
                    const chart_data = {
                        labels: labels,
                        datasets: [{
                        label: 'Execution miutes',
                        fill: true,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgb(54, 162, 235)',
                        pointBackgroundColor: 'rgb(54, 162, 235)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(54, 162, 235)',
                        data: values,
                        }]
                    };

                    const config = {
                        type: checkedValue,                    
                        data: chart_data,
                        options: {responsive : false}
                    };
                    let chartStatus = Chart.getChart("myChart");
                    if (chartStatus != undefined) {
                    chartStatus.destroy();
                    }

                    const myChart = new Chart(
                        document.getElementById('myChart'),
                        config
                    );
                });      
            }
        }

        e.preventDefault();
    });
    
    
    function padTo2Digits(num) {
        return num.toString().padStart(2, '0');
    }

    function formatDate(date) {
        return [
            padTo2Digits(date.getDate()),
            padTo2Digits(date.getMonth() + 1),
            date.getFullYear(),
        ].join('/');
    }


    $(document).ready(function () {
        Enable_wf_list(wsname);        
        dt_master = $('#dthist').DataTable(            
            {
            "ajax": {
                "url": "/tasks/gethist/" + wsname + "/" + taskname + "/" + encodeURIComponent(formatDate(new Date($("#startDate").val()))) + "/" + encodeURIComponent(formatDate(new Date($("#endDate").val()))),
                "dataSrc": function ( json ) {
                    for ( var i=0, ien=json.length ; i<ien ; i++ ) {
                        var element = {}
                        element.id = i;
                        json[i].id = i; 
                        json[i].duration = json[i].duration
                    }
                    return json;
                }
            },            
            "columns": [       
                { "data": "wsname" }, 
                { "data": "taskname" },                
                { "data": "start_date" },         
                { "data": "end_date" },
                { "data": "duration" }                
            ],
                responsive: true
            });        
    });
    </script>
